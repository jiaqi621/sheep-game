<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>郭了个王</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #f0e6d2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px; /* 移动端减少内边距 */
            min-height: 100vh;
            touch-action: manipulation; /* 优化移动端点击 */
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            padding: 0 5px;
        }

        .game-title {
            text-align: center;
            font-size: clamp(20px, 5vw, 28px); /* 响应式字体 */
            color: #8b5a2b;
            margin-bottom: 15px;
        }

        /* 卡片区域 - 适配移动端尺寸 */
        .card-area {
            position: relative;
            background-color: #d9c8b4;
            padding: 15px; /* 移动端减少内边距 */
            border-radius: 10px;
            margin-bottom: 15px;
            min-height: clamp(350px, 70vh, 600px); /* 按视口高度适配 */
            overflow: hidden;
            width: 100%;
        }

        /* 卡片样式 - 移动端自适应尺寸 */
        .card {
            position: absolute;
            width: clamp(50px, 18vw, 80px); /* 移动端最小50px，最大80px */
            height: clamp(65px, 24vw, 105px); /* 宽高比保持3:4 */
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, z-index 0.2s;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            user-select: none;
            z-index: 1;
            touch-action: manipulation; /* 防止移动端双击缩放 */
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
            z-index: 10;
        }

        .card.disabled {
            opacity: 0;
            cursor: not-allowed;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.2s;
        }

        /* 收集槽 - 移动端适配 */
        .collect-slot {
            display: flex;
            gap: 8px; /* 移动端减小间距 */
            padding: 10px;
            background-color: #e8d9c3;
            border-radius: 8px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }

        .slot {
            width: clamp(45px, 16vw, 70px);
            height: clamp(60px, 21vw, 90px);
            background-color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
        }

        /* 胜利/失败弹窗 - 移动端优化 */
        .victory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            padding: 25px 15px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .victory-title {
            font-size: clamp(24px, 6vw, 36px);
            color: #8b5a2b;
            margin-bottom: 15px;
        }

        .victory-text {
            font-size: clamp(16px, 3vw, 18px);
            margin-bottom: 25px;
            color: #555;
            padding: 0 10px;
        }

        .restart-btn {
            padding: 10px 25px;
            background-color: #8b5a2b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: clamp(14px, 3vw, 16px);
            cursor: pointer;
            transition: background-color 0.2s;
            width: clamp(150px, 50vw, 250px);
        }

        .restart-btn:hover {
            background-color: #6d4421;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">郭了个王</h1>
        
        <!-- 收集槽 -->
        <div class="collect-slot">
            <div class="slot" id="slot1"></div>
            <div class="slot" id="slot2"></div>
            <div class="slot" id="slot3"></div>
            <div class="slot" id="slot4"></div>
            <div class="slot" id="slot5"></div>
            <div class="slot" id="slot6"></div>
            <div class="slot" id="slot7"></div>
        </div>
        
        <!-- 卡片区域 -->
        <div class="card-area" id="cardArea"></div>
        
        <!-- 胜利弹窗 -->
        <div class="victory-modal" id="victoryModal">
            <div class="modal-content">
                <h2 class="victory-title">恭喜通关！</h2>
                <p class="victory-text">你愿意嫁给我吗？</p>
                <button class="restart-btn" id="restartBtn">正在播放语音，请勿退出</button>
            </div>
        </div>

        <!-- 失败弹窗 -->
        <div class="victory-modal" id="failModal">
            <div class="modal-content">
                <h2 class="victory-title">游戏失败</h2>
                <p class="victory-text">收集槽已满，无法继续消除！</p>
                <button class="restart-btn" id="failRestartBtn">重新开始</button>
            </div>
        </div>
    </div>

    <script>
        // 卡片图案链接列表
        const cardImages = [
            "https://s41.ax1x.com/2025/12/24/pZG6NsH.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6deA.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6tQe.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6mM4.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6uL9.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6nsJ.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6VRU.jpg",
            "https://s41.ax1x.com/2025/12/24/pZG6ZzF.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZOVf.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZqqP.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZHKI.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZTxA.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZo2d.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZI8H.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZ5Pe.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZh5D.jpg",
            "https://s41.ax1x.com/2025/12/23/pZGZfUO.jpg"
        ];

        // 游戏配置（区分移动端/桌面端卡片数量）
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const GAME_CONFIG = {
            totalLayers: isMobile ? 3 : 3,         // 移动端仅1层
            cardsPerLayer: isMobile ? 18 : 21,     // 移动端减少卡片数（18张，3的倍数）
            slotCount: 7,           
            matchCount: 3,          
            victoryAudioUrl: "https://jiaqi621.github.io/sheep-game/test.m4a",
            cardSpacing: isMobile ? 15 : 10        // 移动端增大间距
        };

        // 游戏状态
        let gameState = {
            cards: [],              
            slots: [],              
            remainingCards: 0,      
            isGameOver: false       
        };

        // 初始化游戏
        function initGame() {
            gameState = {
                cards: [],
                slots: Array(GAME_CONFIG.slotCount).fill(null),
                remainingCards: 0,
                isGameOver: false
            };

            document.getElementById("victoryModal").style.display = "none";
            document.getElementById("failModal").style.display = "none";

            generateStackedCards();
            renderCards();
            bindEvents();
        }

        // 生成分散排布的卡片（适配移动端尺寸）
        function generateStackedCards() {
            const cardArea = document.getElementById("cardArea");
            // 实时获取卡片区域尺寸（适配移动端）
            const areaWidth = cardArea.clientWidth - 40;  // 移动端减少边距
            const areaHeight = cardArea.clientHeight - 40;
            // 实时获取卡片尺寸（适配CSS的clamp）
            const cardWidth = parseFloat(getComputedStyle(document.querySelector('.card')).width);
            const cardHeight = parseFloat(getComputedStyle(document.querySelector('.card')).height);
            const spacing = GAME_CONFIG.cardSpacing;

            let cardId = 0;
            const allCards = [];
            const totalCards = GAME_CONFIG.totalLayers * GAME_CONFIG.cardsPerLayer;
            const cardTypes = cardImages.length;
            
            // 保证数量为3的倍数
            const baseCountPerType = Math.floor(totalCards / cardTypes);
            const countPerType = Math.floor(baseCountPerType / 3) * 3;
            let remainingCards = totalCards - (countPerType * cardTypes);
            
            // 移动端优化网格：按实际卡片尺寸计算行列
            const colCount = Math.floor(areaWidth / (cardWidth + spacing));
            const rowCount = Math.floor(areaHeight / (cardHeight + spacing));
            const gridPositions = [];
            for (let r = 0; r < rowCount; r++) {
                for (let c = 0; c < colCount; c++) {
                    const x = 20 + c * (cardWidth + spacing); // 移动端减少左偏移
                    const y = 20 + r * (cardHeight + spacing); // 移动端减少上偏移
                    gridPositions.push({x, y});
                }
            }

            // 生成卡片
            for (let type = 0; type < cardTypes; type++) {
                let currentTypeCount = countPerType;
                if (remainingCards > 0) {
                    const addCount = Math.min(3, remainingCards);
                    currentTypeCount += addCount;
                    remainingCards -= addCount;
                }

                for (let layer = 0; layer < GAME_CONFIG.totalLayers; layer++) {
                    const countInLayer = Math.floor(currentTypeCount / GAME_CONFIG.totalLayers);
                    for (let i = 0; i < countInLayer; i++) {
                        let pos;
                        // 移动端优先用网格，避免重叠
                        if (gridPositions.length > 0) {
                            const posIndex = Math.floor(Math.random() * gridPositions.length);
                            pos = gridPositions.splice(posIndex, 1)[0];
                        } else {
                            // 随机坐标也限制范围
                            pos = {
                                x: 20 + Math.random() * (areaWidth - cardWidth - 10),
                                y: 20 + Math.random() * (areaHeight - cardHeight - 10)
                            };
                        }
                        
                        // 移动端z-index差值更小，几乎无遮挡
                        const zIndex = layer * 3 + Math.floor(Math.random() * 2);
                        
                        allCards.push({
                            id: `card-${cardId++}`,
                            type: type,
                            image: cardImages[type],
                            x: pos.x,
                            y: pos.y,
                            zIndex: zIndex,
                            isVisible: true,
                            layer: layer
                        });
                    }
                }
            }

            // 兜底校验
            const finalTotal = allCards.length;
            if (finalTotal % 3 !== 0) {
                const needAdd = 3 - (finalTotal % 3);
                for (let i = 0; i < needAdd; i++) {
                    const type = Math.floor(Math.random() * cardTypes);
                    const pos = gridPositions.length > 0 
                        ? gridPositions[Math.floor(Math.random() * gridPositions.length)]
                        : {
                            x: 20 + Math.random() * (areaWidth - cardWidth - 10),
                            y: 20 + Math.random() * (areaHeight - cardHeight - 10)
                          };
                    const zIndex = Math.floor(Math.random() * 2);
                    
                    allCards.push({
                        id: `card-${cardId++}`,
                        type: type,
                        image: cardImages[type],
                        x: pos.x,
                        y: pos.y,
                        zIndex: zIndex,
                        isVisible: true,
                        layer: 0
                    });
                }
            }

            const shuffledCards = shuffleArray(allCards);
            gameState.cards = shuffledCards;
            gameState.remainingCards = shuffledCards.length;
            
            console.log("设备类型：", isMobile ? "移动端" : "桌面端");
            console.log("总卡片数：", gameState.remainingCards);
        }

        // 渲染卡片
        function renderCards() {
            const cardArea = document.getElementById("cardArea");
            cardArea.innerHTML = "";

            gameState.cards.forEach(card => {
                if (card.isVisible) {
                    const cardElement = document.createElement("div");
                    cardElement.className = "card";
                    cardElement.dataset.id = card.id;
                    cardElement.dataset.type = card.type;
                    cardElement.style.backgroundImage = `url(${card.image})`;
                    cardElement.style.left = `${card.x}px`;
                    cardElement.style.top = `${card.y}px`;
                    cardElement.style.zIndex = card.zIndex;
                    cardArea.appendChild(cardElement);
                }
            });
        }

        // 绑定事件（适配移动端触摸）
        function bindEvents() {
            const cardArea = document.getElementById("cardArea");
            // 同时支持点击和触摸事件
            cardArea.addEventListener("click", handleCardInteraction);
            cardArea.addEventListener("touchstart", (e) => {
                e.preventDefault(); // 防止触摸时滚动
                handleCardInteraction(e);
            });

            document.getElementById("restartBtn").addEventListener("click", initGame);
            document.getElementById("failRestartBtn").addEventListener("click", initGame);

            // 窗口大小变化时重新渲染
            window.addEventListener("resize", () => {
                if (!gameState.isGameOver) {
                    generateStackedCards();
                    renderCards();
                }
            });
        }

        // 处理卡片交互（点击/触摸）
        function handleCardInteraction(e) {
            if (gameState.isGameOver) return;
            
            const cardElement = e.target.closest(".card");
            if (!cardElement) return;

            const cardId = cardElement.dataset.id;
            const cardType = parseInt(cardElement.dataset.type);
            
            addToSlot(cardType, cardId);
        }

        // 将卡片添加到收集槽
        function addToSlot(cardType, cardId) {
            const emptySlotIndex = gameState.slots.findIndex(slot => slot === null);
            
            if (emptySlotIndex === -1) {
                gameState.isGameOver = true;
                showFailModal();
                return;
            }

            gameState.slots[emptySlotIndex] = cardType;
            updateSlotUI();
            hideCard(cardId);
            checkMatch();
            checkVictory();
        }

        // 隐藏卡片
        function hideCard(cardId) {
            const cardIndex = gameState.cards.findIndex(card => card.id === cardId);
            if (cardIndex !== -1) {
                gameState.cards[cardIndex].isVisible = false;
                gameState.remainingCards--;
                
                const cardElement = document.querySelector(`.card[data-id="${cardId}"]`);
                if (cardElement) {
                    cardElement.classList.add("disabled");
                }
            }
        }

        // 更新收集槽UI
        function updateSlotUI() {
            gameState.slots.forEach((slotValue, index) => {
                const slotElement = document.getElementById(`slot${index + 1}`);
                if (slotValue === null) {
                    slotElement.style.backgroundImage = "none";
                } else {
                    slotElement.style.backgroundImage = `url(${cardImages[slotValue]})`;
                }
            });
        }

        // 检查消除
        function checkMatch() {
            const typeCount = {};
            gameState.slots.forEach(type => {
                if (type !== null) {
                    typeCount[type] = (typeCount[type] || 0) + 1;
                }
            });

            for (const [type, count] of Object.entries(typeCount)) {
                if (count >= GAME_CONFIG.matchCount) {
                    removeFromSlot(parseInt(type));
                    break;
                }
            }
        }

        // 移除收集槽卡片
        function removeFromSlot(cardType) {
            let removedCount = 0;
            gameState.slots = gameState.slots.map(slot => {
                if (slot === cardType && removedCount < GAME_CONFIG.matchCount) {
                    removedCount++;
                    return null;
                }
                return slot;
            });
            updateSlotUI();
        }

        // 检查胜利
        function checkVictory() {
            if (gameState.remainingCards === 0 && !gameState.isGameOver) {
                gameState.isGameOver = true;
                showVictoryModal();
            }
        }

        // 显示胜利弹窗
        function showVictoryModal() {
            const modal = document.getElementById("victoryModal");
            modal.style.display = "flex";
            playVictoryAudio();
        }

        // 显示失败弹窗
        function showFailModal() {
            const modal = document.getElementById("failModal");
            modal.style.display = "flex";
        }

        // 播放胜利语音
        function playVictoryAudio() {
            if (GAME_CONFIG.victoryAudioUrl) {
                try {
                    const audio = new Audio(GAME_CONFIG.victoryAudioUrl);
                    audio.autoplay = true;
                    audio.controls = false;
                    audio.play().catch(err => {
                        console.log("语音播放失败:", err);
                        const modalContent = document.querySelector(".modal-content");
                        const audioBtn = document.createElement("button");
                        audioBtn.className = "restart-btn";
                        audioBtn.style.marginTop = "10px";
                        audioBtn.textContent = "播放胜利语音";
                        audioBtn.onclick = () => audio.play();
                        modalContent.appendChild(audioBtn);
                    });
                } catch (err) {
                    console.log("创建音频对象失败:", err);
                }
            }
        }

        // 数组打乱
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 页面加载初始化
        window.addEventListener("load", initGame);
    </script>
</body>
</html>
